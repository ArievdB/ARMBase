{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "MachinePrefix": {
        "type": "string",
        "defaultValue": "i"
      },
      "DomainName": {
        "type": "string",
        "defaultValue": "Cistec.es"
      },
      "MachineCount": {
        "type": "int",
        "defaultValue": 2
      },
      "MachineSize": {
        "type": "string",
        "defaultValue": "Standard_A0"
      },
      "VNetName": {
        "type": "string",
        "defaultValue": "Test"
      },
      "SubnetName": {
        "type": "string",
        "defaultValue": "Test"
      },
      "VNetResourceGroup": {
        "type": "string",
        "defaultValue": "Test"
      },
      "StorageType": {
        "type": "string",
        "defaultValue": "Standard_LRS"
      },
      "MachineImagePublisher": {
        "type": "string",
        "defaultValue": "MicrosoftWindowsServer"
      },
      "MachineImageOffer": {
        "type": "string",
        "defaultValue": "WindowsServer"
      },
      "MachineOSVersion": {
        "type": "string",
        "defaultValue": "2016-Datacenter"
      },
      "AdminUser": {
        "type": "string"
      },
      "AdminPassword": {
        "type": "securestring"
      },
      "Environments": {
        "type": "string"
      },
      "SecondaryDiskSizeGB": {
        "type": "int",
        "defaultValue": 10
      },
      "AutomationShutdownTags": {
        "type": "string",
        "defaultValue": "DoNotShutDown"
      },
      "rgLocation": {
        "type": "string",
        "defaultValue": "westeurope"
      },
      "rgName": {
        "type": "string",
        "defaultValue": "default"
      },
      "Team": {
        "type": "string",
        "defaultValue": "unknown"
      },
      "CostValue": {
        "type": "string",
        "defaultValue": "unknown"
      },
      "Product": {
        "type": "string",
        "defaultValue": "unknown"
      },
      "functional-area": {
        "type": "string",
        "defaultValue": "unknown",
        "allowedValues": [
          "Company1"
        ]
      }
    },
    "variables": {
      
      "VnetId": "[resourceId(parameters('VNetResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('VNetName'))]",
      "SubnetId": "[concat(variables('VnetId'),'/subnets/', parameters('SubnetName'))]",
      "AsId": "[resourceId('Microsoft.Compute/availabilitySets',concat(parameters('MachinePrefix'),'-','as'))]",
      
      "EnvContainer": "develop",
      "URIPrefix": "https://",
      "URIPostfix": ".blob.core.windows.net"
    },
    "resources": [
      {
        "type": "Microsoft.Compute/availabilitySets",
        "name": "[concat(parameters('MachinePrefix'),'-','as')]",
        "apiVersion": "2017-03-30",
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "Aligned"
        },
        "dependsOn": [
        ],
        "tags": {
          "displayName": "AvaliabilitySet",
          "team": "[parameters('Team')]",
          "costvalue": "[parameters('costvalue')]",
          "product": "[parameters('Product')]",
          "functional-area": "[parameters('functional-area')]"
        },
        "properties": {
          "platformFaultDomainCount": 2,
          "platformUpdateDomainCount": 3
        }
      },
      {
        "name": "[concat(parameters('MachinePrefix'),'-','ni','-',padLeft(copyindex(1),2,'0'))]",
        "type": "Microsoft.Network/networkInterfaces",
        "location": "[resourceGroup().location]",
        "apiVersion": "2017-06-01",
        "dependsOn": [
        ],
        "copy": {
          "name": "nicLoop",
          "count": "[parameters('MachineCount')]"
        },
        "tags": {
          "displayName": "NetworkInterface",
          "team": "[parameters('Team')]",
          "costvalue": "[parameters('costvalue')]",
          "product": "[parameters('Product')]",
          "functional-area": "[parameters('functional-area')]"
        },
        "properties": {
          "ipConfigurations": [
            {
              "name": "ipconfig1",
              "properties": {
                "privateIPAllocationMethod": "Dynamic",
                "subnet": {
                  "id": "[variables('SubnetId')]"
                }
              }
            }
          ]
        }
      },
      {
        "name": "[concat(parameters('MachinePrefix'),'-',padLeft(copyindex(1),2,'0'))]",
        "type": "Microsoft.Compute/virtualMachines",
        "location": "[resourceGroup().location]",
        "apiVersion": "2017-03-30",
        "dependsOn": [
          "[concat('Microsoft.Network/networkInterfaces/', parameters('MachinePrefix'),'-','ni','-',padLeft(copyindex(1),2,'0'))]",
          "[concat('Microsoft.Compute/availabilitySets/',parameters('MachinePrefix'),'-','as')]"
        ],
        "copy": {
          "name": "machineLoop",
          "count": "[parameters('MachineCount')]"
        },
        "tags": {
          "displayName": "Machines",
          "team": "[parameters('Team')]",
          "costvalue": "[parameters('costvalue')]",
          "product": "[parameters('Product')]",
          "AutoShutdownSchedule": "[parameters('AutomationShutdownTags')]",
          "functional-area": "[parameters('functional-area')]"
        },
        "properties": {
          "availabilitySet": {
            "id": "[resourceId('Microsoft.Compute/availabilitySets', concat(parameters('MachinePrefix'),'-','as'))]"
          },
          "hardwareProfile": {
            "vmSize": "[parameters('MachineSize')]"
          },
          "osProfile": {
            "windowsConfiguration": {
              "provisionVMAgent": true,
              "enableAutomaticUpdates": false
            },
            "computerName": "[concat(parameters('MachinePrefix'),'-',padLeft(copyindex(1),2,'0'))]",
            "adminUsername": "[parameters('AdminUser')]",
            "adminPassword": "[parameters('AdminPassword')]"
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "[parameters('MachineImagePublisher')]",
              "offer": "[parameters('MachineImageOffer')]",
              "sku": "[parameters('MachineOSVersion')]",
              "version": "latest"
            },
            "osDisk": {
              "name": "[concat(parameters('MachinePrefix'),'-',padLeft(copyindex(1),2,'0'),'-os')]",
              "managedDisk": {
                "storageAccountType": "[parameters('StorageType')]"
              },
              "caching": "ReadWrite",
              "createOption": "FromImage"
            },
            "dataDisks": [
              {
                "name": "[concat(parameters('MachinePrefix'),'-',padLeft(copyindex(1),2,'0'),'-data-f')]",
                "lun": 0,
                "createOption": "Empty",
                "diskSizeGB": "[parameters('SecondaryDiskSizeGB')]"
              }
            ]
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('MachinePrefix'),'-','ni','-',padLeft(copyindex(1),2,'0')))]"
              }
            ]
          }
        }
      }
    ],
    "outputs": {
      "deployment": {
        "type": "object",
        "value": "[deployment()]"
      }
    }
  }
  